{% extends "base.html" %}
{% block content %}

<script>
    const deleteReview = (cabinId, reviewId) => {
        fetch(
            `/cabins/${cabinId}/review/${reviewId}`,
            { method: "DELETE" },
        ).then(() => {
            window.location = `/cabins/${cabinId}`;
        });
    };
</script>

<h2>
    {{ cabin.name }}
    <span class="stars">
        {% if cabin.avg_rating %}
            {% for i in range(cabin.avg_rating) %}
                ★
            {% endfor %}
        {% endif %}
    </span>
</h2>


<div id="image-carousel" data-ride="carousel" class="carousel slide" data-ride="carousel">
    <ol class="carousel-indicators">
        {% for i in range(cabin.images|length) %}
            {% if i == 0 %}
                <li data-target="#image-carousel" data-slide-to="{{ i }}" class="active"></li>
            {% else %}
                <li data-target="#image-carousel" data-slide-to="{{ i }}"></li>
            {% endif %}
        {% endfor %}
    </ol>

    <div class="carousel-inner">
        {% for i in range(cabin.images|length) %}
            {% if i == 0 %}
                <div class="carousel-item active">
                    <img src="data:{{ cabin.images[i] }}" class="d-block w-100"></img>
                </div>
            {% else %}
                <div class="carousel-item">
                    <img src="data:{{ cabin.images[i] }}" class="d-block w-100"></img>
                </div>
            {% endif %}
        {% endfor %}
    </div>

    <a class="carousel-control-prev" href="#image-carousel" role="button" data-slide="prev">
        <span class="carousel-control-prev-icon" aria-hidde="true"></span>
        <span class="sr-only">Previous</span>
    </a>

    <a class="carousel-control-next" href="#image-carousel" role="button" data-slide="next">
        <span class="carousel-control-next-icon" aria-hidde="true"></span>
        <span class="sr-only">Next</span>
    </a>
</div>

<div id="cabin">
    <h3>Description</h3>
    {% if cabin.description %}
        <p class="cabin-description">{{ cabin.description }}</p>
    {% else %}
        <p>The cabin owner has added no description.</p>
    {% endif %}
    <p><strong>Price:</strong> {{ cabin.price }}€ / night</p>
    <p>Questions? Email the owner at: <a href="mailto:{{ owner.email }}">{{ owner.email }}</a></p>

    <h3>Keywords</h3>
    {% if keywords|length > 0 %}
        {% for kw in keywords %}
            <span class="badge badge-primary">
                {{ kw.keyword }}
            </span>
        {% endfor %}
    {% else %}
        <p>The cabin owner has added no keywords for this cabin.</p>
    {% endif %}

    <h3>Reservations</h3>
    {% if reservations|length > 0 %}
        <ul>
            {% for reservation in reservations %}
                <li>
                    <p>{{ reservation.start }} - {{ reservation.end }}</p>
                </li>
            {% endfor %}
        </ul>
    {% else %}
        <p>This cabin has no reservations currently.
    {% endif %}
    {% if current_user.is_authenticated and current_user.role == "CUSTOMER"%}
        <p>
            <a class="btn btn-primary" href="/reservations/{{ cabin.id }}">
                Reserve this cabin
            </a>
        </p>
    {% elif not current_user.is_authenticated %}
        <p>
            <a href="/login?next=/reservations/{{ cabin.id }}">Log in</a> to reserve this cabin.
        </p>
    {% endif %}

    <h3>Reviews</h3>
    {% if reviews|length > 0 %}
        <p>
            The cabin has received an average rating of
            {{ cabin.avg_rating }}/5 based on {{ reviews|length }} reviews
        </p>
    {% endif %}

    {% if current_user.is_authenticated %}
        {% if current_user.role == "CUSTOMER" %}
            <p>
                <a class="btn btn-outline-primary" href="/cabins/{{ cabin.id }}/review">
                    Write a review
                </a>
            </p>
        {% endif %}
    {% else %}
        <p>
            <a href="/login?next=/cabins/{{ cabin.id }}/review">Log in</a> to write a review.
        </p>
    {% endif %}

    {% if reviews|length > 0 %}
        <hr>
        {% for review in reviews %}
            <div class="review">
                <div class="card review-card">
                    <div class="stars review-stars card-title">
                        {% for i in range(review.rating) %}
                            ★
                        {% endfor %}
                    </div>

                    <p class="card-text">
                        {% if review.content %}
                                <span class="review-content">{{ review.content }}</span>
                        {% else %}
                            No content
                        {% endif %}
                    </p>

                    {% if (
                        current_user.is_authenticated
                        and (current_user.role == "ADMIN")
                        or (current_user.role == "OWNER" and cabin.owner_id == current_user.id)
                        or (current_user.role == "CUSTOMER" and review.user_id == current_user.id)
                    ) %}
                        <div class="card-footer bg-transparent">
                            <button class="btn btn-danger" onclick="deleteReview({{ cabin.id }}, {{ review.id }});">
                                Delete review
                            </button>
                        </div>
                    {% endif %}
                </div>
            </div>
        {% endfor %}
    {% else %}
        <p>No reviews given yet.</p>
    {% endif %}

</div>

{% endblock %}
